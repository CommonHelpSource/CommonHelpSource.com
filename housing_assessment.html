<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Housing Assessment Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      background: #f5f6f7;
      color: #333;
      line-height: 1.6;
    }
    .content-wrapper {
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }
    .results-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }
    .situation-summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #e53935;
    }
    .action-steps {
      margin-top: 30px;
    }
    .action-step {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .action-step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .step-number {
      display: inline-block;
      width: 24px;
      height: 24px;
      background: #e53935;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      margin-right: 10px;
      font-size: 0.9rem;
    }
    .step-title {
      font-weight: 600;
      color: #e53935;
      margin-bottom: 8px;
    }
    .step-description {
      margin-left: 34px;
      color: #555;
    }
    .contact-info {
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
      margin-left: 34px;
      font-size: 0.9rem;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .loading:after {
      content: "...";
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }
    .chat-container {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .chat-input {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      padding: 12px 24px;
      background: #e53935;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #c62828;
    }
    .next-steps {
      margin-top: 30px;
      padding: 20px;
      background: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    }
    .next-steps h3 {
      margin-top: 0;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <!-- Header will be inserted by header.js -->
  <div class="content-wrapper">
    <div class="results-container">
      <h1>Your Housing Assessment Results</h1>
      <div id="loading" class="loading">Analyzing your responses</div>
      <div id="results" style="display: none;">
        <div id="situationSummary" class="situation-summary"></div>
        <div id="actionSteps" class="action-steps"></div>
        <div id="nextSteps" class="next-steps">
          <h3>What's Next?</h3>
          <p>Need more specific guidance or have questions about these resources? Use the chat below to ask for clarification or additional help.</p>
        </div>
      </div>
    </div>

    <div class="chat-container">
      <div id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="userInput" placeholder="Ask a question about these resources...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script src="assets/js/header.js"></script>
  <script>
    // Load and validate assessment data
    const assessmentData = JSON.parse(localStorage.getItem('housing_assessment_complete'));
    if (!assessmentData) {
      window.location.href = 'index.html';
    }

    // Format the initial system message with assessment data
    function getSystemMessage() {
      return {
        role: "system",
        content: `You are a helpful housing assistance expert. Format your responses in a clear, structured way:
        1. Start with a direct acknowledgment of the user's situation
        2. Provide a brief summary of their likely challenges
        3. List 3-5 specific, actionable steps with clear contact information
        4. Use proper spacing and formatting for readability
        5. Only include relevant resources based on their location and needs
        
        Current user information:
        - ZIP Code: ${assessmentData.zip}
        - Housing Status: ${assessmentData.phase1.status}
        - Duration: ${assessmentData.phase1.duration}
        - Eviction Risk: ${assessmentData.phase1.evictionRisk}
        - Safety Concerns: ${assessmentData.phase1.safety}
        - Accessibility Needs: ${assessmentData.phase1.accessibility}
        - Household Size: ${assessmentData.phase1.householdSize}
        - Monthly Income: $${assessmentData.phase2.income}
        - Housing Cost: $${assessmentData.phase2.housingCost}
        - Past Due Bills: ${assessmentData.phase2.pastDue}
        - Housing Barriers: ${assessmentData.phase2.barriers.join(', ')}
        - Employment: ${assessmentData.phase2.employment}
        - Assistance Type Needed: ${assessmentData.phase2.assistanceType}
        - Additional Needs: ${assessmentData.phase2.additionalNeeds}
        
        When providing resources, format them clearly with organization names in bold, followed by contact information and specific instructions.`
      };
    }

    // Generate initial assessment results
    async function generateResults() {
      try {
        const messages = [
          getSystemMessage(),
          {
            role: "user",
            content: "Based on my assessment answers, what specific housing resources and next steps do you recommend?"
          }
        ];

        const response = await fetch('/.netlify/functions/chatgpt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to get response');
        
        // Parse and format the response
        const content = data.response.content;
        
        // Hide loading, show results
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        
        // Split the content into sections and format
        const sections = content.split('\n\n');
        
        // Display situation summary (first paragraph)
        document.getElementById('situationSummary').innerHTML = sections[0];
        
        // Format and display action steps
        const actionStepsHtml = sections.slice(1)
          .map(section => {
            if (section.startsWith('1.') || section.startsWith('2.') || section.startsWith('3.') || section.startsWith('4.') || section.startsWith('5.')) {
              const stepMatch = section.match(/(\d+)\.\s+(.*?)(?:\n|$)([\s\S]*)/);
              if (stepMatch) {
                const [_, number, title, description] = stepMatch;
                return `
                  <div class="action-step">
                    <div class="step-title">
                      <span class="step-number">${number}</span>
                      ${title}
                    </div>
                    <div class="step-description">${description}</div>
                  </div>
                `;
              }
            }
            return `<p>${section}</p>`;
          })
          .join('');
        
        document.getElementById('actionSteps').innerHTML = actionStepsHtml;

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = 'Error loading results. Please try again.';
      }
    }

    // Handle follow-up chat messages
    async function sendMessage() {
      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();
      if (!message) return;

      const chatMessages = document.getElementById('chatMessages');
      
      // Add user message
      chatMessages.innerHTML += `
        <div style="margin: 10px 0; text-align: right;">
          <div style="display: inline-block; background: #e3f2fd; padding: 10px; border-radius: 8px; max-width: 80%;">
            ${message}
          </div>
        </div>
      `;

      userInput.value = '';

      try {
        const messages = [
          getSystemMessage(),
          {
            role: "user",
            content: message
          }
        ];

        const response = await fetch('/.netlify/functions/chatgpt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to get response');

        // Add AI response
        chatMessages.innerHTML += `
          <div style="margin: 10px 0;">
            <div style="display: inline-block; background: #f5f5f5; padding: 10px; border-radius: 8px; max-width: 80%;">
              ${data.response.content.replace(/\n/g, '<br>')}
            </div>
          </div>
        `;

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;

      } catch (error) {
        console.error('Error:', error);
        chatMessages.innerHTML += `
          <div style="margin: 10px 0; color: #c62828;">
            Error sending message. Please try again.
          </div>
        `;
      }
    }

    // Handle Enter key in chat input
    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // Generate initial results
    generateResults();
  </script>
</body>
</html>